jobs:
  build-and-test-raspberry-pi:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    strategy:
      matrix:
        platform: [linux/arm/v7, linux/arm64]  # ARMv7 and ARM64 for Raspberry Pi

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: network=host

    - name: Build and test Docker image for ${{ matrix.platform }}
      run: |
        MAX_RETRIES=3
        RETRY_COUNT=0

        # Replace forward slashes in platform name for valid Docker tag
        PLATFORM_TAG=$(echo "${{ matrix.platform }}" | sed 's|/|-|g')

        while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
          echo "Attempt $((RETRY_COUNT+1)) for ${{ matrix.platform }} (tag: $PLATFORM_TAG)"

          # Remove any existing test image
          docker rmi -f yolov11-hailo-detection:$PLATFORM_TAG-test || true

          # Build the Docker image with Hailo dependency for the specific platform
          if docker buildx build \
            --platform ${{ matrix.platform }} \
            --load \
            -t yolov11-hailo-detection:$PLATFORM_TAG-test \
            --build-arg HAILO_VERSION=${{ env.HAILO_VERSION }} \
            --build-arg PYTHON_VERSION=${{ env.PYTHON_VERSION }} \
            --cache-from=type=gha \
            --cache-to=type=gha,mode=max \
            . ; then

            echo "Build successful for ${{ matrix.platform }}"

            # Test the Docker image
            if timeout 60s docker run --rm yolov11-hailo-detection:$PLATFORM_TAG-test python3 -c "
            import sys
            print(f'Python version: {sys.version}')
            try:
                import cv2
                print(f'OpenCV version: {cv2.__version__}')
            except ImportError:
                print('OpenCV import failed')
                sys.exit(1)
            try:
                import numpy
                print(f'NumPy version: {numpy.__version__}')
            except ImportError:
                print('NumPy import failed')
                sys.exit(1)
            try:
                import flask
                print(f'Flask version: {flask.__version__}')
            except ImportError:
                print('Flask import failed')
                sys.exit(1)
            try:
                import loguru
                print(f'Loguru version: {getattr(loguru, \"__version__\", \"unknown\")}')
            except ImportError:
                print('Loguru import failed')
                sys.exit(1)
            print('Basic imports successful')
            "; then
              echo "Test passed for ${{ matrix.platform }}"
              break  # Exit the retry loop on success
            else
              echo "Test failed for ${{ matrix.platform }}"
            fi
          else
            echo "Build failed for ${{ matrix.platform }}"
          fi

          RETRY_COUNT=$((RETRY_COUNT+1))

          if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
            echo "Cleaning up and preparing for retry..."
            sleep 5  # Brief pause before retry
          fi
        done

        # If we exhausted all retries, exit with error
        if [ $RETRY_COUNT -ge $MAX_RETRIES ]; then
          echo "Failed to build and test successfully after $MAX_RETRIES attempts for ${{ matrix.platform }}"
          exit 1
        fi

        echo "Successfully built and tested for ${{ matrix.platform }} after $RETRY_COUNT attempt(s)"
